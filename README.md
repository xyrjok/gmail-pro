<div _ngcontent-ng-c2284167979="" inline-copy-host="" class="markdown markdown-main-panel tutor-markdown-rendering enable-updated-hr-color" id="model-response-message-contentr_d2bd667538a7b83c" aria-live="polite" aria-busy="false" dir="ltr" style="--animation-duration: 400ms; --fade-animation-function: linear;"><h1 data-path-to-node="3">📬 XYRJ Gmail 智能多账号分发系统</h1><p data-path-to-node="4">这是一个基于 <b data-path-to-node="4" data-index-in-node="7">Cloudflare Workers</b>、<b data-path-to-node="4" data-index-in-node="26">Cloudflare Pages</b> 和 <b data-path-to-node="4" data-index-in-node="45">D1 数据库</b> 构建的长效、全自动邮件分发系统。</p><h2 data-path-to-node="5">🌟 系统核心特性</h2><ul data-path-to-node="6"><li><p data-path-to-node="6,0,0"><b data-path-to-node="6,0,0" data-index-in-node="0">双模发信</b>：支持直接调用 <code data-path-to-node="6,0,0" data-index-in-node="12">Gmail API (OAuth2)</code> 或通过 <code data-path-to-node="6,0,0" data-index-in-node="35">Google Apps Script (GAS)</code> 转发。</p></li><li><p data-path-to-node="6,1,0"><b data-path-to-node="6,1,0" data-index-in-node="0">任务级控制</b>：每个任务可独立指定发送模式和发送账号。</p></li><li><p data-path-to-node="6,2,0"><b data-path-to-node="6,2,0" data-index-in-node="0">长效永久</b>：内置 OAuth 2.0 刷新机制，只需一次授权，永久自动延期。</p></li><li><p data-path-to-node="6,3,0"><b data-path-to-node="6,3,0" data-index-in-node="0">自动循环</b>：支持循环任务，发送成功后自动计算下一次发送时间。</p></li><li><p data-path-to-node="6,4,0"><b data-path-to-node="6,4,0" data-index-in-node="0">数据驱动</b>：Worker 作为纯执行器，一切逻辑由数据库指令决定。</p></li></ul><hr data-path-to-node="7"><h2 data-path-to-node="8">🏗️ 数据库架构 (D1)</h2><p data-path-to-node="9">系统依赖于四张核心表：</p><ol start="1" data-path-to-node="10"><li><p data-path-to-node="10,0,0"><b data-path-to-node="10,0,0" data-index-in-node="0"><code data-path-to-node="10,0,0" data-index-in-node="0">accounts</code> (账号表)</b>：存储 Gmail API 凭证或 GAS URL。</p></li><li><p data-path-to-node="10,1,0"><b data-path-to-node="10,1,0" data-index-in-node="0"><code data-path-to-node="10,1,0" data-index-in-node="0">send_tasks</code> (任务表)</b>：存储待发送的邮件内容、目标、执行模式及成功/失败计数。</p></li><li><p data-path-to-node="10,2,0"><b data-path-to-node="10,2,0" data-index-in-node="0"><code data-path-to-node="10,2,0" data-index-in-node="0">access_rules</code> (规则表)</b>：定义邮件抓取与匹配的过滤逻辑。</p></li><li><p data-path-to-node="10,3,0"><b data-path-to-node="10,3,0" data-index-in-node="0"><code data-path-to-node="10,3,0" data-index-in-node="0">filter_groups</code> (策略组)</b>：用于批量管理过滤规则的逻辑分组。</p></li></ol><hr data-path-to-node="11"><h2 data-path-to-node="12">🚀 部署步骤</h2><h3 data-path-to-node="13">1. 数据库准备</h3><p data-path-to-node="14">在 Cloudflare D1 控制台执行 SQL 建表语句（参考项目中的 <code data-path-to-node="14" data-index-in-node="38">schema.sql</code>）。确保 <code data-path-to-node="14" data-index-in-node="53">accounts</code> 表中已填入有效的 <code data-path-to-node="14" data-index-in-node="71">refresh_token</code> 或 <code data-path-to-node="14" data-index-in-node="87">script_url</code>。</p><h3 data-path-to-node="15">2. 前端部署 (Cloudflare Pages)</h3><ul data-path-to-node="16"><li><p data-path-to-node="16,0,0">将前端代码部署至 Pages。</p></li><li><p data-path-to-node="16,1,0">在 Pages 设置中绑定 D1 数据库，变量名设为 <code data-path-to-node="16,1,0" data-index-in-node="27">XYRJ_GMAIL</code>。</p></li><li><p data-path-to-node="16,2,0">前端负责：创建任务、配置账号、切换发送模式。</p></li></ul><h3 data-path-to-node="17">3. 后端执行器 (Cloudflare Worker)</h3><ul data-path-to-node="18"><li><p data-path-to-node="18,0,0">创建一个独立的 Worker。</p></li><li><p data-path-to-node="18,1,0"><b data-path-to-node="18,1,0" data-index-in-node="0">数据库绑定</b>：在 Worker 设置中绑定 D1 数据库，变量名必须为 <code data-path-to-node="18,1,0" data-index-in-node="35">XYRJ_GMAIL</code>。</p></li><li><p data-path-to-node="18,2,0"><b data-path-to-node="18,2,0" data-index-in-node="0">配置触发器</b>：添加 Cron Trigger，设置为 <code data-path-to-node="18,2,0" data-index-in-node="26">* * * * *</code> (每分钟执行一次)。</p></li><li><p data-path-to-node="18,3,0"><b data-path-to-node="18,3,0" data-index-in-node="0">部署代码</b>：将 <code data-path-to-node="18,3,0" data-index-in-node="7">worker.js</code> 中的代码复制并部署。</p></li></ul><hr data-path-to-node="19"><h2 data-path-to-node="20">🛠️ Worker 工作流程<div class="attachment-container search-images"><response-element class="" ng-version="0.0.0-PLACEHOLDER"><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><single-image _nghost-ng-c316246853="" data-is-interactive="false" class="ng-star-inserted"><!----><div _ngcontent-ng-c316246853="" class="image-container ng-star-inserted" data-full-size-image-uri="https://encrypted-tbn1.gstatic.com/licensed-image?q=tbn:ANd9GcSPRFf-9-lxtYzbGnOtNuMS6qQIyvwmKPman6Fg0EmgdPcW_GEV5_ZyfhR7R56hu_g3l4WANn0-tZHR-vFOQlcqUxk2IQQ_3ER0N1kK5jXh3P99nvs"><div _ngcontent-ng-c316246853="" class="overlay-container ng-star-inserted"><!----><button _ngcontent-ng-c316246853="" class="image-button ng-star-inserted" jslog="181501;track:generic_click,impression;BardVeMetadataKey:[[&quot;r_d2bd667538a7b83c&quot;,&quot;c_5b9ca5e11fffc231&quot;,null,&quot;rc_1fc8348298cdfea4&quot;,null,null,&quot;zh&quot;,null,1,null,null,1,0]];mutable:true"><img _ngcontent-ng-c316246853="" loading="lazy" class="licensed-image loaded" alt="Image of software execution flow chart" src="https://encrypted-tbn1.gstatic.com/licensed-image?q=tbn:ANd9GcSPRFf-9-lxtYzbGnOtNuMS6qQIyvwmKPman6Fg0EmgdPcW_GEV5_ZyfhR7R56hu_g3l4WANn0-tZHR-vFOQlcqUxk2IQQ_3ER0N1kK5jXh3P99nvs"></button><!----><!----><!----><!----><!----><!----><!----><div _ngcontent-ng-c316246853="" class="licensed-image-source ng-star-inserted"><span _ngcontent-ng-c316246853="" class="label ellipsis gds-label-m-alt">Shutterstock</span></div><!----><!----><!----></div><!----><!----></div><!----><!----><!----><!----><!----><!----></single-image><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----></response-element></div></h2><ol start="1" data-path-to-node="22"><li><p data-path-to-node="22,0,0"><b data-path-to-node="22,0,0" data-index-in-node="0">唤醒</b>：每分钟由 Cloudflare 定时器强制唤醒。</p></li><li><p data-path-to-node="22,1,0"><b data-path-to-node="22,1,0" data-index-in-node="0">捞取</b>：通过 <code data-path-to-node="22,1,0" data-index-in-node="6">LEFT JOIN</code> 查询，一次性提取 <code data-path-to-node="22,1,0" data-index-in-node="25">next_run_at</code> 到期的任务及其对应的账号密钥。</p></li><li><p data-path-to-node="22,2,0"><b data-path-to-node="22,2,0" data-index-in-node="0">鉴权</b>：</p><ul data-path-to-node="22,2,1"><li><p data-path-to-node="22,2,1,0,0">若是 <b data-path-to-node="22,2,1,0,0" data-index-in-node="3">API 模式</b>：检查缓存，若无则使用 <code data-path-to-node="22,2,1,0,0" data-index-in-node="21">refresh_token</code> 向 Google 申请新的 <code data-path-to-node="22,2,1,0,0" data-index-in-node="49">access_token</code>。</p></li><li><p data-path-to-node="22,2,1,1,0">若是 <b data-path-to-node="22,2,1,1,0" data-index-in-node="3">GAS 模式</b>：直接准备请求目标 URL。</p></li></ul></li><li><p data-path-to-node="22,3,0"><b data-path-to-node="22,3,0" data-index-in-node="0">发送</b>：调用 Gmail 服务发出邮件。</p></li><li><p data-path-to-node="22,4,0"><b data-path-to-node="22,4,0" data-index-in-node="0">回写</b>：</p><ul data-path-to-node="22,4,1"><li><p data-path-to-node="22,4,1,0,0"><b data-path-to-node="22,4,1,0,0" data-index-in-node="0">成功</b>：<code data-path-to-node="22,4,1,0,0" data-index-in-node="3">success_count</code> +1；若是循环任务，根据 <code data-path-to-node="22,4,1,0,0" data-index-in-node="30">delay_config</code> 更新下一次运行时间。</p></li><li><p data-path-to-node="22,4,1,1,0"><b data-path-to-node="22,4,1,1,0" data-index-in-node="0">失败</b>：<code data-path-to-node="22,4,1,1,0" data-index-in-node="3">fail_count</code> +1，保留任务状态以便下次重试。</p></li></ul></li></ol><hr data-path-to-node="23"><h2 data-path-to-node="24">📝 任务状态说明 (前端显示)</h2><ul data-path-to-node="25"><li><p data-path-to-node="25,0,0"><b data-path-to-node="25,0,0" data-index-in-node="0">等待中 (0/1)</b>：任务已创建，等待 Worker 第一次抓取。</p></li><li><p data-path-to-node="25,1,0"><b data-path-to-node="25,1,0" data-index-in-node="0">等待中 (0/2)</b>：批量任务或需执行两次的任务，目前成功次数为 0。</p></li><li><p data-path-to-node="25,2,0"><b data-path-to-node="25,2,0" data-index-in-node="0">已完成 (1/1)</b>：单次任务发送成功。</p></li><li><p data-path-to-node="25,3,0"><b data-path-to-node="25,3,0" data-index-in-node="0">持续增加的失败计数</b>：若邮件已收到但计数不更新，请检查数据库字段是否与 Worker 代码中的 SQL 语句完全匹配（重点检查是否存在 <code data-path-to-node="25,3,0" data-index-in-node="67">updated_at</code> 等额外字段）。</p></li></ul><hr data-path-to-node="26"><h2 data-path-to-node="27">⚠️ 安全提醒</h2><ul data-path-to-node="28"><li><p data-path-to-node="28,0,0"><b data-path-to-node="28,0,0" data-index-in-node="0">数据库安全</b>：<code data-path-to-node="28,0,0" data-index-in-node="6">accounts</code> 表包含敏感凭证，请勿将数据库查询权限随意公开。</p></li><li><p data-path-to-node="28,1,0"><b data-path-to-node="28,1,0" data-index-in-node="0">额度限制</b>：请注意 Google API 的每日发送限额（普通 Gmail 账号通常为 500-2000 封/日）。</p></li></ul></div>
